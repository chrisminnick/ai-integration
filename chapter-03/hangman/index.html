<!DOCTYPE html>
<html>
  <head>
    <script
      src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.22.0/dist/tf-core.min.js"
      integrity="sha256-CSRDh4j/faV7FND3xFoF2BYRpaS1JlPabQZehtNIdXw="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <div id="word" style="font-size: 2em; letter-spacing: 0.5em"></div>
    <input id="guess" maxlength="1" style="width: 2em; text-align: center" />
    <button id="btn">Guess</button>

    <script type="module">
      import * as transformers from 'https://cdn.jsdelivr.net/npm/@xenova/transformers@2.17.2/dist/transformers.min.js';

      (async () => {
        // Load pipeline first
        const pipe = await transformers.pipeline(
          'text-generation',
          'Xenova/gpt2'
        );

        // Use AI to generate a 5-letter word
        let secret = '';
        while (!secret) {
          const prompt =
            'Output only a random, common, real 5-letter English word:';
          const out = await pipe(prompt, {
            max_new_tokens: 5,
            temperature: 0.9,
            top_p: 0.95,
            do_sample: true,
          });
          const aiText = out[0].generated_text.replace(prompt, '').trim();
          // Remove punctuation and split by whitespace
          const cleaned = aiText.replace(/[^a-zA-Z\s]/g, ' ').trim();
          // Split into words and check each for length 5
          const candidates = cleaned.split(/\s+/).filter((w) => w.length === 5);
          console.log(
            'AI output:',
            aiText,
            '\nCleaned:',
            cleaned,
            '\nCandidates:',
            candidates,
            '\n'
          );
          if (candidates.length > 0) {
            secret = candidates[0].toLowerCase();
          }
        }

        let pattern = Array(secret.length).fill('_');
        document.getElementById('word').textContent = pattern.join(' ');
        // track all guesses
        let guessedLetters = new Set();

        document.getElementById('btn').onclick = async () => {
          const g = document.getElementById('guess').value.toLowerCase();
          document.getElementById('guess').value = '';
          // ignore empty or repeated guesses
          if (!g || guessedLetters.has(g)) return;
          guessedLetters.add(g);

          // apply user guess
          pattern = pattern.map((c, i) => (secret[i] === g ? g : c));
          document.getElementById('word').textContent = pattern.join(' ');
          if (!pattern.includes('_')) {
            alert('You won! Refresh to play again.');
            return;
          }

          // AI makes a guess using the language model
          // Use a minimal, direct prompt to avoid repeated words like "suggest"
          const prompt = `Blanks: ${pattern.join(' ')}\nGuessed: ${Array.from(
            guessedLetters
          ).join(', ')}\nNext letter:`;

          const out = await pipe(prompt, {
            max_new_tokens: 1,
            temperature: 1.3,
            top_p: 0.95,
            do_sample: true,
          });
          let aiText = out[0].generated_text
            .replace(prompt, '')
            .trim()
            .toLowerCase();
          console.log(
            'AI output:',
            out[0].generated_text,
            'Extracted:',
            aiText
          );
          // Only take the first unused alphabetic character that is not in guessedLetters
          let aiGuess =
            (aiText.match(/[a-z]/g) || []).find(
              (l) => !guessedLetters.has(l)
            ) || '';
          if (!aiGuess) {
            // fallback: pick a random unused letter
            const alphabet = 'abcdefghijklmnopqrstuvwxyz'.split('');
            const unused = alphabet.filter((l) => !guessedLetters.has(l));
            aiGuess = unused[Math.floor(Math.random() * unused.length)] || '';
          }
          if (!aiGuess) return;
          guessedLetters.add(aiGuess);

          // apply AI guess
          pattern = pattern.map((c, i) =>
            secret[i] === aiGuess ? aiGuess : c
          );
          document.getElementById('word').textContent = pattern.join(' ');
          console.log('AI guesses:', aiGuess);
          if (!pattern.includes('_')) {
            alert('AI won! Refresh to play again.');
            return;
          }
        };
      })();
    </script>
  </body>
</html>
